<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Le Juge de toute la terre</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #1a1a1a; 
            color: white; 
            margin: 0; 
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        h1 {
            color: #4CAF50;
            margin-bottom: 30px;
            text-align: center;
        }
        
        #image-container { 
            width: 90%;
            max-width: 800px;
            height: 450px;
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border: 3px solid #333; 
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        #viewer {
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            cursor: pointer;
        }
        
        .info-text {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 10px 0;
        }
        
        audio {
            width: 90%;
            max-width: 640px;
            margin: 20px 0;
        }
        
        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
            max-width: 800px;
        }
    </style>
</head>
<body>
    <h1>Lecteur Audio-Image Synchronisé</h1>
    
    <div id="image-container">
        <img id="viewer" src="0.jpg" alt="Image synchronisée">
    </div>
    
    <div class="info-text">Cliquez sur l'image pour le mode plein écran</div>
    
    <div id="error-message" class="error"></div>
    
    <audio id="audioPlayer" controls preload="metadata">
        <source src="audio.m4a" type="audio/mp4">
        <source src="audio.mp3" type="audio/mpeg">
        Votre navigateur ne supporte pas la lecture audio.
    </audio>

    <script>
        // ==========================================
        // CONFIGURATION : LISTE DES IMAGES
        // Modifiez les chiffres ci-dessous (secondes)
        // ==========================================
        const AVAILABLE_IMAGES = [
            0,
            117,
            158,
            190,
            201,
            220,
            259,
            303,
            330,
            367,
            391,
            425,
            472,
            507,
            560,
            580,
            599
        ];
        // ==========================================

        // Éléments DOM
        const audio = document.getElementById('audioPlayer');
        const img = document.getElementById('viewer');
        const errorMsg = document.getElementById('error-message');
        
        // Variables d'état
        let imageCache = {};
        
        // Initialisation
        window.addEventListener('load', function() {
            preloadImage(AVAILABLE_IMAGES[0]);
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Synchronisation auto lors de la lecture
            audio.addEventListener('timeupdate', throttle(syncImage, 1000));
            
            // Synchronisation immédiate si on déplace la barre de progression
            audio.addEventListener('seeked', function() {
                setTimeout(syncImage, 200); 
            });
            
            img.addEventListener('click', toggleFullscreen);
            
            audio.addEventListener('error', function() {
                showError("Erreur audio: " + (audio.error ? audio.error.code : "inconnue"));
            });
        }
        
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        function syncImage() {
            if (!audio.duration) return;
            const targetSecond = Math.floor(audio.currentTime);
            findBestImageForTime(targetSecond);
        }
        
        function findBestImageForTime(targetSecond) {
            let bestMatch = AVAILABLE_IMAGES[0];
            
            for (const imageSecond of AVAILABLE_IMAGES) {
                if (imageSecond <= targetSecond) {
                    bestMatch = imageSecond;
                } else {
                    break;
                }
            }
            loadSpecificImage(bestMatch);
        }
        
        function loadSpecificImage(imageSecond) {
            const imageName = imageSecond + ".jpg";
            if (img.src.includes(imageName)) return;
            
            if (imageCache[imageName]) {
                img.src = imageName;
                return;
            }
            
            preloadAndShowImage(imageSecond);
        }
        
        function preloadAndShowImage(imageSecond) {
            const imageName = imageSecond + ".jpg";
            const newImg = new Image();
            
            newImg.onload = function() {
                imageCache[imageName] = true;
                img.src = imageName;
                preloadAdjacentImages(AVAILABLE_IMAGES.indexOf(imageSecond));
            };
            
            newImg.src = imageName;
        }
        
        function preloadImage(imageSecond) {
            const imageName = imageSecond + ".jpg";
            if (!imageCache[imageName]) {
                const preloadImg = new Image();
                preloadImg.src = imageName;
                preloadImg.onload = () => imageCache[imageName] = true;
            }
        }
        
        function preloadAdjacentImages(currentIndex) {
            if (currentIndex + 1 < AVAILABLE_IMAGES.length) {
                preloadImage(AVAILABLE_IMAGES[currentIndex + 1]);
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                if (img.requestFullscreen) img.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
        
        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }
    </script>
</body>
</html>
